// ═══════════════════════════════════════════════════════════════════════════
// NyayBooker Backend - Prisma Schema
// ═══════════════════════════════════════════════════════════════════════════
// 
// PostgreSQL database schema for Neon
// Run: npx prisma generate && npx prisma db push
//
// ═══════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum Role {
  USER
  LAWYER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  WALLET
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum DocumentType {
  BAR_COUNCIL_CERTIFICATE
  ID_PROOF
  DEGREE_CERTIFICATE
  CASE_DOCUMENT
  CONTRACT
  AVATAR
  OTHER
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_REMINDER
  PAYMENT_RECEIVED
  PAYMENT_REFUNDED
  REVIEW_RECEIVED
  PROFILE_VERIFIED
  MESSAGE_RECEIVED
  SYSTEM
}

// ═══════════════════════════════════════════════════════════════════════════
// USER MODEL
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  password            String
  googleId            String?   @unique @map("google_id")
  role                Role      @default(USER)
  
  // Profile Information
  firstName           String    @map("first_name")
  lastName            String    @map("last_name")
  phone               String?
  avatar              String?
  
  // Verification
  isEmailVerified     Boolean   @default(false) @map("is_email_verified")
  isPhoneVerified     Boolean   @default(false) @map("is_phone_verified")
  emailVerifiedAt     DateTime? @map("email_verified_at")
  
  // Account Status
  isActive            Boolean   @default(true) @map("is_active")
  lastLoginAt         DateTime? @map("last_login_at")
  lastLoginIp         String?   @map("last_login_ip")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  deletedAt           DateTime? @map("deleted_at")
  
  // Relations
  lawyer              Lawyer?
  bookingsAsClient    Booking[] @relation("ClientBookings")
  reviewsGiven        Review[]  @relation("ReviewAuthor")
  documents           Document[]
  notifications       Notification[]
  refreshTokens       RefreshToken[]
  
  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

// ═══════════════════════════════════════════════════════════════════════════
// LAWYER MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Lawyer {
  id                  String              @id @default(uuid())
  userId              String              @unique @map("user_id")
  
  // Professional Information
  barCouncilId        String              @unique @map("bar_council_id")
  barCouncilState     String              @map("bar_council_state")
  enrollmentYear      Int                 @map("enrollment_year")
  
  // Profile
  bio                 String?             @db.Text
  headline            String?
  experience          Int                 @default(0) // Years
  
  // Pricing
  hourlyRate          Decimal             @default(0) @map("hourly_rate") @db.Decimal(10, 2)
  currency            String              @default("INR")
  
  // Location
  city                String?
  state               String?
  address             String?             @db.Text
  pincode             String?
  
  // Verification
  verificationStatus  VerificationStatus  @default(PENDING) @map("verification_status")
  verifiedAt          DateTime?           @map("verified_at")
  verifiedBy          String?             @map("verified_by")
  rejectionReason     String?             @map("rejection_reason")
  
  // Availability
  isAvailable         Boolean             @default(true) @map("is_available")
  availability        Json?               // Weekly schedule
  
  // Statistics (denormalized for performance)
  totalBookings       Int                 @default(0) @map("total_bookings")
  completedBookings   Int                 @default(0) @map("completed_bookings")
  totalEarnings       Decimal             @default(0) @map("total_earnings") @db.Decimal(12, 2)
  averageRating       Float               @default(0) @map("average_rating")
  totalReviews        Int                 @default(0) @map("total_reviews")
  
  // SEO & Discovery
  slug                String?             @unique
  featured            Boolean             @default(false)
  featuredOrder       Int?                @map("featured_order")
  
  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  
  // Relations
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  specializations     LawyerSpecialization[]
  qualifications      Qualification[]
  bookings            Booking[]           @relation("LawyerBookings")
  reviews             Review[]            @relation("ReviewSubject")
  
  @@index([barCouncilId])
  @@index([verificationStatus])
  @@index([city, state])
  @@index([averageRating])
  @@index([hourlyRate])
  @@index([slug])
  @@map("lawyers")
}

// ═══════════════════════════════════════════════════════════════════════════
// LAWYER SPECIALIZATION (Many-to-Many with Practice Areas)
// ═══════════════════════════════════════════════════════════════════════════

model PracticeArea {
  id                  String                @id @default(uuid())
  name                String                @unique
  slug                String                @unique
  description         String?               @db.Text
  icon                String?
  
  // Hierarchy
  parentId            String?               @map("parent_id")
  parent              PracticeArea?         @relation("PracticeAreaHierarchy", fields: [parentId], references: [id])
  children            PracticeArea[]        @relation("PracticeAreaHierarchy")
  
  // Display
  displayOrder        Int                   @default(0) @map("display_order")
  isActive            Boolean               @default(true) @map("is_active")
  
  // Timestamps
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  
  // Relations
  lawyers             LawyerSpecialization[]
  
  @@index([slug])
  @@index([parentId])
  @@map("practice_areas")
}

model LawyerSpecialization {
  id                  String        @id @default(uuid())
  lawyerId            String        @map("lawyer_id")
  practiceAreaId      String        @map("practice_area_id")
  isPrimary           Boolean       @default(false) @map("is_primary")
  yearsExperience     Int?          @map("years_experience")
  
  // Relations
  lawyer              Lawyer        @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  practiceArea        PracticeArea  @relation(fields: [practiceAreaId], references: [id], onDelete: Cascade)
  
  @@unique([lawyerId, practiceAreaId])
  @@index([practiceAreaId])
  @@map("lawyer_specializations")
}

// ═══════════════════════════════════════════════════════════════════════════
// QUALIFICATION MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Qualification {
  id                  String    @id @default(uuid())
  lawyerId            String    @map("lawyer_id")
  
  degree              String
  institution         String
  year                Int
  description         String?   @db.Text
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  lawyer              Lawyer    @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  
  @@index([lawyerId])
  @@map("qualifications")
}

// ═══════════════════════════════════════════════════════════════════════════
// BOOKING MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Booking {
  id                  String        @id @default(uuid())
  bookingNumber       String        @unique @map("booking_number")
  
  // Participants
  clientId            String        @map("client_id")
  lawyerId            String        @map("lawyer_id")
  
  // Schedule
  scheduledDate       DateTime      @map("scheduled_date")
  scheduledTime       String        @map("scheduled_time") // "HH:mm" format
  duration            Int           @default(60) // Minutes
  timezone            String        @default("Asia/Kolkata")
  
  // Status
  status              BookingStatus @default(PENDING)
  confirmedAt         DateTime?     @map("confirmed_at")
  completedAt         DateTime?     @map("completed_at")
  cancelledAt         DateTime?     @map("cancelled_at")
  cancelledBy         String?       @map("cancelled_by")
  cancellationReason  String?       @map("cancellation_reason") @db.Text
  
  // Meeting Details
  meetingType         String        @default("VIDEO") @map("meeting_type") // VIDEO, PHONE, IN_PERSON
  meetingLink         String?       @map("meeting_link")
  meetingNotes        String?       @map("meeting_notes") @db.Text
  
  // Pricing
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("INR")
  
  // Client Notes
  clientNotes         String?       @map("client_notes") @db.Text
  lawyerNotes         String?       @map("lawyer_notes") @db.Text
  
  // Rescheduling
  originalBookingId   String?       @map("original_booking_id")
  rescheduledFrom     Booking?      @relation("RescheduledBooking", fields: [originalBookingId], references: [id])
  rescheduledTo       Booking[]     @relation("RescheduledBooking")
  
  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  
  // Relations
  client              User          @relation("ClientBookings", fields: [clientId], references: [id])
  lawyer              Lawyer        @relation("LawyerBookings", fields: [lawyerId], references: [id])
  payment             Payment?
  review              Review?
  
  @@index([clientId])
  @@index([lawyerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([bookingNumber])
  @@map("bookings")
}

// ═══════════════════════════════════════════════════════════════════════════
// PAYMENT MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Payment {
  id                  String        @id @default(uuid())
  bookingId           String        @unique @map("booking_id")
  
  // Amount
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("INR")
  
  // Status
  status              PaymentStatus @default(PENDING)
  method              PaymentMethod?
  
  // Gateway Details (Razorpay)
  gatewayOrderId      String?       @unique @map("gateway_order_id")
  gatewayPaymentId    String?       @unique @map("gateway_payment_id")
  gatewaySignature    String?       @map("gateway_signature")
  
  // Processing
  processedAt         DateTime?     @map("processed_at")
  failedAt            DateTime?     @map("failed_at")
  failureReason       String?       @map("failure_reason")
  
  // Refund
  refundedAmount      Decimal?      @map("refunded_amount") @db.Decimal(10, 2)
  refundedAt          DateTime?     @map("refunded_at")
  refundReason        String?       @map("refund_reason")
  refundId            String?       @map("refund_id")
  
  // Metadata
  metadata            Json?
  
  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  
  // Relations
  booking             Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([gatewayOrderId])
  @@index([gatewayPaymentId])
  @@map("payments")
}

// ═══════════════════════════════════════════════════════════════════════════
// REVIEW MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Review {
  id                  String    @id @default(uuid())
  bookingId           String    @unique @map("booking_id")
  authorId            String    @map("author_id")
  lawyerId            String    @map("lawyer_id")
  
  // Rating
  rating              Int       // 1-5
  title               String?
  content             String?   @db.Text
  
  // Verification
  isVerified          Boolean   @default(true) @map("is_verified") // Verified purchase
  
  // Moderation
  isPublished         Boolean   @default(true) @map("is_published")
  isHidden            Boolean   @default(false) @map("is_hidden")
  hiddenReason        String?   @map("hidden_reason")
  
  // Response
  lawyerResponse      String?   @map("lawyer_response") @db.Text
  respondedAt         DateTime? @map("responded_at")
  
  // Helpful votes
  helpfulCount        Int       @default(0) @map("helpful_count")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  booking             Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  author              User      @relation("ReviewAuthor", fields: [authorId], references: [id])
  lawyer              Lawyer    @relation("ReviewSubject", fields: [lawyerId], references: [id])
  
  @@index([lawyerId])
  @@index([authorId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// ═══════════════════════════════════════════════════════════════════════════
// DOCUMENT MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Document {
  id                  String        @id @default(uuid())
  userId              String        @map("user_id")
  
  // File Information
  name                String
  originalName        String        @map("original_name")
  type                DocumentType
  mimeType            String        @map("mime_type")
  size                Int           // Bytes
  
  // Storage
  storagePath         String        @map("storage_path")
  storageUrl          String?       @map("storage_url")
  
  // Access Control
  isPublic            Boolean       @default(false) @map("is_public")
  sharedWith          String[]      @map("shared_with") // Array of user IDs
  
  // Metadata
  description         String?       @db.Text
  metadata            Json?
  
  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  deletedAt           DateTime?     @map("deleted_at")
  
  // Relations
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("documents")
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATION MODEL
// ═══════════════════════════════════════════════════════════════════════════

model Notification {
  id                  String            @id @default(uuid())
  userId              String            @map("user_id")
  
  // Content
  type                NotificationType
  title               String
  message             String            @db.Text
  
  // Status
  isRead              Boolean           @default(false) @map("is_read")
  readAt              DateTime?         @map("read_at")
  
  // Action
  actionUrl           String?           @map("action_url")
  actionLabel         String?           @map("action_label")
  
  // Metadata
  metadata            Json?
  
  // Timestamps
  createdAt           DateTime          @default(now()) @map("created_at")
  expiresAt           DateTime?         @map("expires_at")
  
  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// ═══════════════════════════════════════════════════════════════════════════
// REFRESH TOKEN MODEL
// ═══════════════════════════════════════════════════════════════════════════

model RefreshToken {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  
  token               String    @unique
  expiresAt           DateTime  @map("expires_at")
  
  // Device Info
  userAgent           String?   @map("user_agent")
  ipAddress           String?   @map("ip_address")
  
  // Status
  isRevoked           Boolean   @default(false) @map("is_revoked")
  revokedAt           DateTime? @map("revoked_at")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  
  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// PASSWORD RESET TOKEN MODEL
// ═══════════════════════════════════════════════════════════════════════════

model PasswordResetToken {
  id                  String    @id @default(uuid())
  email               String
  token               String    @unique
  expiresAt           DateTime  @map("expires_at")
  usedAt              DateTime? @map("used_at")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  
  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// EMAIL VERIFICATION TOKEN MODEL
// ═══════════════════════════════════════════════════════════════════════════

model EmailVerificationToken {
  id                  String    @id @default(uuid())
  email               String
  token               String    @unique
  expiresAt           DateTime  @map("expires_at")
  usedAt              DateTime? @map("used_at")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  
  @@index([email])
  @@index([token])
  @@map("email_verification_tokens")
}
