generator client {
  provider = "prisma-client-js"
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "ERD.svg"
//   format   = "svg"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  password         String
  googleId         String?        @unique @map("google_id")
  role             Role           @default(USER)
  firstName        String         @map("first_name")
  lastName         String         @map("last_name")
  phone            String?
  avatar           String?
  isEmailVerified  Boolean        @default(false) @map("is_email_verified")
  isPhoneVerified  Boolean        @default(false) @map("is_phone_verified")
  emailVerifiedAt  DateTime?      @map("email_verified_at")
  isActive         Boolean        @default(true) @map("is_active")
  lastLoginAt      DateTime?      @map("last_login_at")
  lastLoginIp      String?        @map("last_login_ip")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  deletedAt        DateTime?      @map("deleted_at")
  auditLogs        AuditLog[]
  bookingsAsClient Booking[]      @relation("ClientBookings")
  casesAsClient    Case[]         @relation("ClientCases")
  documents        Document[]
  lawyer           Lawyer?
  messages         Message[]
  notifications    Notification[]
  refreshTokens    RefreshToken[]
  reviewsGiven     Review[]       @relation("ReviewAuthor")
  savedLawyers     SavedLawyer[]

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Lawyer {
  id                 String                 @id @default(uuid())
  userId             String                 @unique @map("user_id")
  barCouncilId       String                 @unique @map("bar_council_id")
  barCouncilState    String                 @map("bar_council_state")
  enrollmentYear     Int                    @map("enrollment_year")
  languages          String[]               @default([])
  bio                String?
  headline           String?
  experience         Int                    @default(0)
  hourlyRate         Decimal                @default(0) @map("hourly_rate") @db.Decimal(10, 2)
  currency           String                 @default("INR")
  city               String?
  state              String?
  address            String?
  pincode            String?
  verificationStatus VerificationStatus     @default(PENDING) @map("verification_status")
  verifiedAt         DateTime?              @map("verified_at")
  verifiedBy         String?                @map("verified_by")
  rejectionReason    String?                @map("rejection_reason")
  isAvailable        Boolean                @default(true) @map("is_available")
  availability       Json?
  totalBookings      Int                    @default(0) @map("total_bookings")
  completedBookings  Int                    @default(0) @map("completed_bookings")
  totalEarnings      Decimal                @default(0) @map("total_earnings") @db.Decimal(12, 2)
  averageRating      Float                  @default(0) @map("average_rating")
  totalReviews       Int                    @default(0) @map("total_reviews")
  slug               String?                @unique
  featured           Boolean                @default(false)
  featuredOrder      Int?                   @map("featured_order")
  createdAt          DateTime               @default(now()) @map("created_at")
  updatedAt          DateTime               @updatedAt @map("updated_at")
  consultationFee    Decimal                @default(0) @map("consultation_fee") @db.Decimal(10, 2)
  bankAccountName    String?                @map("bank_account_name")
  bankAccountNumber  String?                @map("bank_account_number")
  bankIfscCode       String?                @map("bank_ifsc_code")
  upiId              String?                @map("upi_id")
  blockedPeriods     BlockedPeriod[]
  bookings           Booking[]              @relation("LawyerBookings")
  cases              Case[]
  specializations    LawyerSpecialization[]
  user               User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  qualifications     Qualification[]
  reviews            Review[]               @relation("ReviewSubject")
  savedBy            SavedLawyer[]

  @@index([barCouncilId])
  @@index([verificationStatus])
  @@index([city, state])
  @@index([averageRating])
  @@index([hourlyRate])
  @@index([slug])
  @@map("lawyers")
}

model BlockedPeriod {
  id        String   @id @default(uuid())
  lawyerId  String   @map("lawyer_id")
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lawyer    Lawyer   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@index([lawyerId, startDate])
  @@map("blocked_periods")
}

model PracticeArea {
  id           String                 @id @default(uuid())
  name         String                 @unique
  slug         String                 @unique
  description  String?
  icon         String?
  parentId     String?                @map("parent_id")
  displayOrder Int                    @default(0) @map("display_order")
  isActive     Boolean                @default(true) @map("is_active")
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  lawyers      LawyerSpecialization[]
  parent       PracticeArea?          @relation("PracticeAreaHierarchy", fields: [parentId], references: [id])
  children     PracticeArea[]         @relation("PracticeAreaHierarchy")

  @@index([slug])
  @@index([parentId])
  @@map("practice_areas")
}

model LawyerSpecialization {
  id              String       @id @default(uuid())
  lawyerId        String       @map("lawyer_id")
  practiceAreaId  String       @map("practice_area_id")
  isPrimary       Boolean      @default(false) @map("is_primary")
  yearsExperience Int?         @map("years_experience")
  lawyer          Lawyer       @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  practiceArea    PracticeArea @relation(fields: [practiceAreaId], references: [id], onDelete: Cascade)

  @@unique([lawyerId, practiceAreaId])
  @@index([practiceAreaId])
  @@map("lawyer_specializations")
}

model Qualification {
  id          String   @id @default(uuid())
  lawyerId    String   @map("lawyer_id")
  degree      String
  institution String
  year        Int
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lawyer      Lawyer   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@index([lawyerId])
  @@map("qualifications")
}

model Booking {
  id                 String        @id @default(uuid())
  bookingNumber      String        @unique @map("booking_number")
  clientId           String        @map("client_id")
  lawyerId           String        @map("lawyer_id")
  scheduledDate      DateTime      @map("scheduled_date")
  scheduledTime      String        @map("scheduled_time")
  duration           Int           @default(60)
  timezone           String        @default("Asia/Kolkata")
  status             BookingStatus @default(PENDING)
  confirmedAt        DateTime?     @map("confirmed_at")
  completedAt        DateTime?     @map("completed_at")
  cancelledAt        DateTime?     @map("cancelled_at")
  cancelledBy        String?       @map("cancelled_by")
  cancellationReason String?       @map("cancellation_reason")
  meetingType        String        @default("VIDEO") @map("meeting_type")
  meetingLink        String?       @map("meeting_link")
  meetingNotes       String?       @map("meeting_notes")
  amount             Decimal       @db.Decimal(10, 2)
  currency           String        @default("INR")
  clientNotes        String?       @map("client_notes")
  lawyerNotes        String?       @map("lawyer_notes")
  originalBookingId  String?       @map("original_booking_id")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  client             User          @relation("ClientBookings", fields: [clientId], references: [id])
  lawyer             Lawyer        @relation("LawyerBookings", fields: [lawyerId], references: [id])
  rescheduledFrom    Booking?      @relation("RescheduledBooking", fields: [originalBookingId], references: [id])
  rescheduledTo      Booking[]     @relation("RescheduledBooking")
  case               Case?
  payment            Payment?
  review             Review?

  @@index([clientId])
  @@index([lawyerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([bookingNumber])
  @@map("bookings")
}

model Payment {
  id               String         @id @default(uuid())
  bookingId        String         @unique @map("booking_id")
  amount           Decimal        @db.Decimal(10, 2)
  currency         String         @default("INR")
  status           PaymentStatus  @default(PENDING)
  method           PaymentMethod?
  gatewayOrderId   String?        @unique @map("gateway_order_id")
  gatewayPaymentId String?        @unique @map("gateway_payment_id")
  gatewaySignature String?        @map("gateway_signature")
  processedAt      DateTime?      @map("processed_at")
  failedAt         DateTime?      @map("failed_at")
  failureReason    String?        @map("failure_reason")
  refundedAmount   Decimal?       @map("refunded_amount") @db.Decimal(10, 2)
  refundedAt       DateTime?      @map("refunded_at")
  refundReason     String?        @map("refund_reason")
  refundId         String?        @map("refund_id")
  metadata         Json?
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  booking          Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([gatewayOrderId])
  @@index([gatewayPaymentId])
  @@map("payments")
}

model Review {
  id             String    @id @default(uuid())
  bookingId      String    @unique @map("booking_id")
  authorId       String    @map("author_id")
  lawyerId       String    @map("lawyer_id")
  rating         Int
  title          String?
  content        String?
  isVerified     Boolean   @default(true) @map("is_verified")
  isPublished    Boolean   @default(true) @map("is_published")
  isHidden       Boolean   @default(false) @map("is_hidden")
  hiddenReason   String?   @map("hidden_reason")
  lawyerResponse String?   @map("lawyer_response")
  respondedAt    DateTime? @map("responded_at")
  helpfulCount   Int       @default(0) @map("helpful_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  author         User      @relation("ReviewAuthor", fields: [authorId], references: [id])
  booking        Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  lawyer         Lawyer    @relation("ReviewSubject", fields: [lawyerId], references: [id])

  @@index([lawyerId])
  @@index([authorId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model Document {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  name         String
  originalName String       @map("original_name")
  type         DocumentType
  mimeType     String       @map("mime_type")
  size         Int
  storagePath  String       @map("storage_path")
  storageUrl   String?      @map("storage_url")
  isPublic     Boolean      @default(false) @map("is_public")
  sharedWith   String[]     @map("shared_with")
  description  String?
  metadata     Json?
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  deletedAt    DateTime?    @map("deleted_at")
  caseId       String?      @map("case_id")
  case         Case?        @relation(fields: [caseId], references: [id])
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@index([type])
  @@index([createdAt])
  @@map("documents")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String           @map("user_id")
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false) @map("is_read")
  readAt      DateTime?        @map("read_at")
  actionUrl   String?          @map("action_url")
  actionLabel String?          @map("action_label")
  metadata    Json?
  createdAt   DateTime         @default(now()) @map("created_at")
  expiresAt   DateTime?        @map("expires_at")
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")
  isRevoked Boolean   @default(false) @map("is_revoked")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("email_verification_tokens")
}

model Case {
  id          String       @id @default(uuid())
  caseNumber  String       @unique @map("case_number")
  title       String
  description String?
  status      CaseStatus   @default(OPEN)
  priority    CasePriority @default(MEDIUM)
  clientId    String       @map("client_id")
  lawyerId    String       @map("lawyer_id")
  bookingId   String?      @unique @map("booking_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  closedAt    DateTime?    @map("closed_at")
  auditLogs   AuditLog[]
  booking     Booking?     @relation(fields: [bookingId], references: [id])
  client      User         @relation("ClientCases", fields: [clientId], references: [id])
  lawyer      Lawyer       @relation(fields: [lawyerId], references: [id])
  casePayments CasePayment[]
  documents   Document[]
  messages    Message[]

  @@index([clientId])
  @@index([lawyerId])
  @@index([status])
  @@index([createdAt])
  @@map("cases")
}

model Message {
  id            String      @id @default(uuid())
  content       String
  type          MessageType @default(TEXT)
  attachmentUrl String?     @map("attachment_url")
  senderId      String      @map("sender_id")
  caseId        String      @map("case_id")
  isRead        Boolean     @default(false) @map("is_read")
  readAt        DateTime?   @map("read_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  case          Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  sender        User        @relation(fields: [senderId], references: [id])

  @@index([caseId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  userId     String      @map("user_id")
  caseId     String?     @map("case_id")
  details    Json?
  createdAt  DateTime    @default(now()) @map("created_at")
  case       Case?       @relation(fields: [caseId], references: [id])
  user       User        @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([caseId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SavedLawyer {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  lawyerId  String   @map("lawyer_id")
  createdAt DateTime @default(now()) @map("created_at")
  lawyer    Lawyer   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lawyerId])
  @@index([userId])
  @@index([lawyerId])
  @@map("saved_lawyers")
}

enum Role {
  USER
  LAWYER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  WALLET
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum DocumentType {
  BAR_COUNCIL_CERTIFICATE
  ID_PROOF
  DEGREE_CERTIFICATE
  CASE_DOCUMENT
  CONTRACT
  AVATAR
  OTHER
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_REMINDER
  PAYMENT_RECEIVED
  PAYMENT_REFUNDED
  PAYMENT_REQUESTED
  PAYMENT_REQUEST_RECEIVED
  REVIEW_RECEIVED
  PROFILE_VERIFIED
  MESSAGE_RECEIVED
  SYSTEM
}

enum CaseStatus {
  OPEN
  IN_PROGRESS
  PENDING_DOCS
  UNDER_REVIEW
  CLOSED
  RESOLVED
  REQUESTED
  REJECTED
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  DOCUMENT_ADDED
  DOCUMENT_REMOVED
  MESSAGE_SENT
  PAYMENT_MADE
  ASSIGNED
}

model CasePayment {
  id                  String            @id @default(cuid())
  caseId              String            @map("case_id")
  amountInPaise       Int               @map("amount_in_paise")
  currency            String            @default("INR")
  status              CasePaymentStatus @default(REQUESTED)
  description         String
  requestedByLawyerId String            @map("requested_by_lawyer_id")
  razorpayOrderId     String?           @unique @map("razorpay_order_id")
  razorpayPaymentId   String?           @unique @map("razorpay_payment_id")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  case                Case              @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([status])
  @@index([razorpayOrderId])
  @@map("case_payments")
}

enum CasePaymentStatus {
  REQUESTED
  PROCESSING
  DENIED
  COMPLETED
  FAILED
}
